<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"></head>
<body>
<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

<script>
// Making HTML5 Game
// https://www.youtube.com/user/RainingChain/videos?flow=list&live_view=500&sort=da&view=0

var ctx = document.getElementById("ctx").getContext("2d");

ctx.font = '30px Arial';
ctx.globalAlpha = 0.5;

var WIDTH = 500;
var HEIGHT = 500;
var REFRESH_RATE = 40;
var COLLISION_DISTANCE = 30;

var timeWhenGameStarted = Date.now(); // return time in ms

var frameCount = 0; // ex. Video = 1000/40 = 25fps

var score = 0;
var player;

var enemyList = {};
var upgradeList = {};
var bulletList = {};


// Player
createPlayer = function(){
    player = {
        type:'player',
        id:'P',
        name:'P',
        x:50,
        y:40,
        spdX:30,
        spdY:5,
        hp:10,
        width:20,
        height:20,
        color:'green',
        //
        atkSpd:1,
        attackCounter:0,
        pressingDown:false,
        pressingUp:false,
        pressingLeft:false,
        pressingRight:false,
        aimAngle:0
    };
}

// Enemy
Enemy = function(id,name,x,y,spdX,spdY,width,height){
    var enemy = {
        type:'enemy',
        id:id,
        name:name,
        x:x,
        y:y,
        spdX:spdX,
        spdY:spdY,
        width:width,
        height:height,
        color:'red',
        //
        aimAngle:0,
        atkSpd:1,
        attackCounter:0
    };

    enemyList[id] = enemy;
}

randomlyGenerateEnemy = function(){
    // Math.random() - Generates a random number bewteen 0-10
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var height = 10 + Math.random() * 30;
    var width = 10 + Math.random() * 30;
    var id = Math.random();
    var spdX = 5 + Math.random() * 5;
    var spdY = 5 + Math.random() * 5;

    Enemy(id,id,x,y,spdX,spdY,width,height);
}

// Upgrade
Upgrade = function (id,name,x,y,spdX,spdY,width,height,category,color){
    var asd = {
        type:'upgrade',
        id:id,
        name:name,
        x:x,
        y:y,
        spdX:spdX,
        spdY:spdY,
        width:width,
        height:height,
        color:color,
        //
        category:category
    };

    upgradeList[id] = asd;
}

randomlyGenerateUpgrade = function(){
    // Math.random() - Generates a random number bewteen 0-10
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var height = 10;
    var width = 10;
    var id = Math.random();
    var spdX = 0;
    var spdY = 0;

    if(Math.random() < 0.5){
        var category = 'score';
        var color = 'orange';
    } else {
        var category = 'atkSpd';
        var color = 'purple';
    }

    Upgrade(id,id,x,y,spdX,spdY,width,height,category,color);
}

// Bullet
Bullet = function (id,name,x,y,spdX,spdY,width,height){
    var asd = {
        type:'bullet',
        id:id,
        name:name,
        x:x,
        y:y,
        spdX:spdX,
        spdY:spdY,
        width:width,
        height:height,
        color:'black',
        //
        timer:10
    };

    bulletList[id] = asd;
}

GenerateBullet = function(actor,overwriteAngle){
    // Math.random() - Generates a random number bewteen 0-10
    var x = actor.x;
    var y = actor.y;
    var height = 10;
    var width = 10;
    var id = Math.random();

    var angle = actor.aimAngle;

    if(overwriteAngle !== undefined){ //overwriteAngle is optional
        angle = overwriteAngle;
    }

    //var spdX = Math.cos(angle) * 5; // Angle is in radians
    //var spdY = Math.sin(angle) * 5; // Angle is in radians
    var spdX = Math.cos(angle/180 * Math.PI) * 5; // Angle is in degrees
    var spdY = Math.sin(angle/180 * Math.PI) * 5; // Angle is in degrees

    Bullet(id,id,x,y,spdX,spdY,width,height);
}

document.onclick = function(mouse){ //left-click mouse
    performAttack(player);
}

performAttack = function(actor){
    // Bullets
    if(actor.attackCounter > 25){ // every 1 sec
        actor.attackCounter = 0;
        GenerateBullet(actor);
    }    
}

document.oncontextmenu = function(mouse){ //right-click mouse
    performSpecialAttack(player);
    mouse.preventDefault(); //stops display of context menu
}

performSpecialAttack = function(actor){
    // Bullets
    if(actor.attackCounter > 50){ // every 2 sec
        actor.attackCounter = 0;
        /*
        for(var angle=0;angle < 360;angle++){
            GenerateBullet(actor,angle);
        }
        */
        GenerateBullet(actor,actor.aimAngle - 5);
        GenerateBullet(actor,actor.aimAngle);
        GenerateBullet(actor,actor.aimAngle + 5);
    }
}

document.onmousemove = function(mouse){
    //var mouseX = mouse.clientX - 8;
    //var mouseY = mouse.clientY - 8;
    var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
    var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

    mouseX -= player.x;
    mouseY -= player.y;

    //player.aimAngle = Math.atan2(mouseX,mouseY); //radians
    player.aimAngle = Math.atan2(mouseY,mouseX) / Math.PI * 180; //degrees

}

//event.keyCode
// http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes

document.onkeydown = function(event){
    if(event.keyCode === 68)          // d
        player.pressingRight = true;
    else if(event.keyCode === 83)     // s
        player.pressingDown = true;
    else if(event.keyCode === 65)     // a
        player.pressingLeft = true;
    else if(event.keyCode === 87)     // w
        player.pressingUp = true;
}

document.onkeyup = function(event){
    if(event.keyCode === 68)          // d
        player.pressingRight = false;
    else if(event.keyCode === 83)     // s
        player.pressingDown = false;
    else if(event.keyCode === 65)     // a
        player.pressingLeft = false;
    else if(event.keyCode === 87)     // w
        player.pressingUp = false;
}

updateEntity = function (entity){
    updateEntityPosition(entity);
    drawEntity(entity);
}

updateEntityPosition = function (entity){
    if(entity.type === 'player'){
        if(player.pressingRight)
            player.x += 10;
        if(player.pressingLeft)
            player.x -= 10;
        if(player.pressingDown)
            player.y += 10;
        if(player.pressingUp)
            player.y -= 10;

        //ispositionvalid
        if(player.x < player.width/2)
            player.x = player.width/2;
        if(player.x > WIDTH - player.width/2)
            player.x = WIDTH - player.width/2;
        if(player.y < player.height/2)
            player.y = player.height/2;
        if(player.y > HEIGHT - player.height/2)
            player.y = HEIGHT - player.height/2;
    } else {
        entity.x += entity.spdX;
        entity.y += entity.spdY;

        if (entity.x < 0 || entity.x > WIDTH){
            entity.spdX = -entity.spdX;
        }

        if (entity.y < 0 || entity.y > HEIGHT){
            entity.spdY = -entity.spdY;
        }
    }
}

testCollisionRectRect = function(rect1,rect2){
    return rect1.x <= rect2.x + rect2.width
        && rect2.x <= rect1.x + rect1.width
        && rect1.y <= rect2.y + rect2.height
        && rect2.y <= rect1.y + rect1.height;
}

drawEntity = function (entity){
    ctx.save();
    ctx.fillStyle = entity.color;
    ctx.fillRect(entity.x-entity.width/2,entity.y-entity.height/2,entity.width,entity.height);
    ctx.restore();
}

update = function (){
    ctx.clearRect(0,0,WIDTH,HEIGHT);

    frameCount++;
    score++;

    // Enemies
    if(frameCount % 100 === 0) // every 4 sec
        randomlyGenerateEnemy();

    // Bonus objects
    if(frameCount % 75 === 0) // every 3 sec
        randomlyGenerateUpgrade();

    player.attackCounter += player.atkSpd;

    // Loop thru all bullets
    for(var key in bulletList){
        updateEntity(bulletList[key]);

        var toRemove = false;
        bulletList[key].timer++;
        if(bulletList[key].timer > 100){
            toRemove = true;
        }

        for(var key2 in enemyList){
            var isColliding = testCollisionEntity(bulletList[key],enemyList[key2]);
            if(isColliding){
                toRemove = true;
                delete enemyList[key2];
                break;
            }
        }

        if(toRemove){
            delete bulletList[key];
        }
    }

    // Loop thru all bonus objects
    for(var key in upgradeList){
        updateEntity(upgradeList[key]);
        var isColliding = testCollisionEntity(player,upgradeList[key]);
        if(isColliding){
            if(upgradeList[key].category === 'score')
                score += 1000;
            if(upgradeList[key].category === 'atkSpd')
                player.atkSpd += 3;
            delete upgradeList[key];
        }
    }

    // Loop thru all enemies
    for(var key in enemyList){
        updateEntity(enemyList[key]);
        var isColliding = testCollisionEntity(player,enemyList[key]);
        if(isColliding){
            player.hp--;
        }
    }

    if(player.hp <= 0){
        var timeSurvived = Date.now() - timeWhenGameStarted;
        console.log("You lost! You survived for " + timeSurvived + " ms.");
        startNewGame();
    }

    updateEntity(player);
    ctx.fillText(player.hp + " HP",0,30);
    ctx.fillText('Score: ' + score,200,30);
}

getDistanceBetweenEntity = function (entity1,entity2){
    var dx = entity1.x - entity2.x;
    var dy = entity1.y - entity2.y;
    var result = Math.sqrt(dx*dx+dy*dy);
    return result;
}

testCollisionEntity = function (entity1,entity2){
    var rect1 = {
        x:entity1.x-entity1.width/2,
        y:entity1.y-entity1.height/2,
        width:entity1.width,
        height:entity1.height
    }

    var rect2 = {
        x:entity2.x-entity2.width/2,
        y:entity2.y-entity2.height/2,
        width:entity2.width,
        height:entity2.height
    }

    result = testCollisionRectRect(rect1,rect2);
    return result;
}

startNewGame = function(){
    player.hp = 10;
    timeWhenGameStarted = Date.now();
    frameCount = 0;
    score = 0;
    enemyList = {};
    upgradeList = {};
    bulletList = {};

    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
}

//Enemy('E1','Jack',150,350,10,5,30,30);
//Enemy('E2','Jeremy',250,350,10,-15,20,20);
//Enemy('E3','Kiah',350,350,10,-30,40,10);

createPlayer();
startNewGame();

setInterval(update,REFRESH_RATE);

</script>
</body></html>