<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"></head>
<body>
<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

<script>
    // Making HTML5 Game
    // https://www.youtube.com/user/RainingChain/videos?flow=list&live_view=500&sort=da&view=0

    var ctx = document.getElementById("ctx").getContext("2d");

    ctx.font = '30px Arial';
    ctx.globalAlpha = 0.5;

    var WIDTH = 500;
    var HEIGHT = 500;
    var REFRESH_RATE = 40;
    var COLLISION_DISTANCE = 30;

    var timeWhenGameStarted = Date.now(); // return time in ms

    var frameCount = 0; // ex. Video = 1000/40 = 25fps

    var score = 0;

    var enemyList = {};
    var upgradeList = {};

    // Player
    var player = {
        id:'P',
        name:'P',
        x:50,
        y:40,
        spdX:30,
        spdY:5,
        hp:10,
        width:20,
        height:20,
        color:'green'
    };

    // Enemy
    Enemy = function (id,name,x,y,spdX,spdY,width,height) {
        var enemy = {
            id:id,
            name:name,
            x:x,
            y:y,
            spdX:spdX,
            spdY:spdY,
            width:width,
            height:height,
            color:'red'
        };

        enemyList[id] = enemy;
    }

    randomlyGenerateEnemy = function() {
        // Math.random() - Generates a random number bewteen 0-10
        var x = Math.random() * WIDTH;
        var y = Math.random() * HEIGHT;
        var height = 10 + Math.random() * 30;
        var width = 10 + Math.random() * 30;
        var id = Math.random();
        var spdX = 5 + Math.random() * 5;
        var spdY = 5 + Math.random() * 5;

        Enemy(id,id,x,y,spdX,spdY,width,height);
    }

    // Upgrade
    Upgrade = function (id,name,x,y,spdX,spdY,width,height) {
        var upgrade = {
            id:id,
            name:name,
            x:x,
            y:y,
            spdX:spdX,
            spdY:spdY,
            width:width,
            height:height,
            color:'orange'
        };

        upgradeList[id] = upgrade;
    }

    randomlyGenerateUpgrade = function() {
        // Math.random() - Generates a random number bewteen 0-10
        var x = Math.random() * WIDTH;
        var y = Math.random() * HEIGHT;
        var height = 10;
        var width = 10;
        var id = Math.random();
        var spdX = 0;
        var spdY = 0;

        Upgrade(id,id,x,y,spdX,spdY,width,height);
    }

    document.onmousemove = function(mouse) {
        //var mouseX = mouse.clientX - 8;
        //var mouseY = mouse.clientY - 8;
        var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
        var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

        if(mouseX < player.width/2)
            mouseX = player.width/2;
        if(mouseX > WIDTH - player.width/2)
            mouseX = WIDTH - player.width/2;
        if(mouseY < player.height/2)
            mouseY = player.height/2;
        if(mouseY > HEIGHT - player.height/2)
            mouseY = HEIGHT - player.height/2;
        
        player.x = mouseX;
        player.y = mouseY;
    }

    updateEntity = function (something) {
        updateEntityPosition(something);
        drawEntity(something);
    }

    updateEntityPosition = function (something) {
        something.x += something.spdX;
        something.y += something.spdY;

        if (something.x < 0 || something.x > WIDTH) {
            something.spdX = -something.spdX;
        }
                
        if (something.y < 0 || something.y > HEIGHT) {
            something.spdY = -something.spdY;
        }
    }

    testCollisionRectRect = function(rect1,rect2) {
        return rect1.x <= rect2.x + rect2.width
            && rect2.x <= rect1.x + rect1.width
            && rect1.y <= rect2.y + rect2.height
            && rect2.y <= rect1.y + rect1.height;
    }

    drawEntity = function (something) {
        ctx.save();
        ctx.fillStyle = something.color;
        ctx.fillRect(something.x-something.width/2,something.y-something.height/2,something.width,something.height);
        ctx.restore();
    }


    update = function () {
        ctx.clearRect(0,0,WIDTH,HEIGHT);

        frameCount++;
        score++;

        if(frameCount % 100 === 0) // every 4 sec
            randomlyGenerateEnemy();

        if(frameCount % 75 === 0) // every 3 sec
            randomlyGenerateUpgrade();

        for(var key in upgradeList) {
            updateEntity(upgradeList[key]);

            var isColliding = testCollisionEntity(player,upgradeList[key]);
            if(isColliding) {
                score += 1000;
                delete upgradeList[key];
            }
        }

        for(var key in enemyList) {
            updateEntity(enemyList[key]);

            var isColliding = testCollisionEntity(player,enemyList[key]);
            if(isColliding) {
                player.hp--;
            }
        }

        if(player.hp <= 0) {
            var timeSurvived = Date.now() - timeWhenGameStarted;
            console.log("You lost! You survived for " + timeSurvived + " ms.");
            startNewGame();
        }

        drawEntity(player);
        ctx.fillText(player.hp + " HP",0,30);
        ctx.fillText('Score: ' + score,200,30);
    }

    getDistanceBetweenEntity = function (entity1,entity2) {
        var dx = entity1.x - entity2.x;
        var dy = entity1.y - entity2.y;
        var result = Math.sqrt(dx*dx+dy*dy);
        return result;
    }

    testCollisionEntity = function (entity1,entity2) {
        var rect1 = {
            x:entity1.x-entity1.width/2,
            y:entity1.y-entity1.height/2,
            width:entity1.width,
            height:entity1.height
        }
        
        var rect2 = {
            x:entity2.x-entity2.width/2,
            y:entity2.y-entity2.height/2,
            width:entity2.width,
            height:entity2.height
        }

        result = testCollisionRectRect(rect1,rect2);
        return result;
    }

    startNewGame = function() {
        player.hp = 10;
        timeWhenGameStarted = Date.now();
        frameCount = 0;
        score = 0;
        enemyList = {};
        upgradeList = {};

        randomlyGenerateEnemy();
        randomlyGenerateEnemy();
        randomlyGenerateEnemy();
    }
                                                    
    //Enemy('E1','Jack',150,350,10,5,30,30);
    //Enemy('E2','Jeremy',250,350,10,-15,20,20);
    //Enemy('E3','Kiah',350,350,10,-30,40,10);

    startNewGame();

    setInterval(update,REFRESH_RATE);

</script>
</body></html>